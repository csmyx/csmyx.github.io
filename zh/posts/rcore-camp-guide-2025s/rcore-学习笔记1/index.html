<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>rCore 学习笔记1 | csmyx</title>
<meta name="keywords" content="">
<meta name="description" content="系列: rCore-Camp-Guide-2025S，对应文档第3章的内容">
<meta name="author" content="csmyx">
<link rel="canonical" href="https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.39e47c616e3e0f7289d755b2ba1a62d8bc4acc0f9903926d737de0185ce03512.css" integrity="sha256-OeR8YW4&#43;D3KJ11Wyuhpi2LxKzA&#43;ZA5Jtc33gGFzgNRI=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://csmyx.github.io/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://csmyx.github.io/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://csmyx.github.io/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://csmyx.github.io/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://csmyx.github.io/favicon/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/">
  <meta property="og:site_name" content="csmyx">
  <meta property="og:title" content="rCore 学习笔记1">
  <meta property="og:description" content="系列: rCore-Camp-Guide-2025S，对应文档第3章的内容">
  <meta property="og:locale" content="zh-CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-13T19:35:53+08:00">
    <meta property="article:modified_time" content="2025-04-13T19:35:53+08:00">
      <meta property="og:image" content="https://csmyx.github.io/img/1.png">
      <meta property="og:see_also" content="https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B02/">
      <meta property="og:see_also" content="https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B00/">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://csmyx.github.io/img/1.png">
<meta name="twitter:title" content="rCore 学习笔记1">
<meta name="twitter:description" content="系列: rCore-Camp-Guide-2025S，对应文档第3章的内容">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "文章",
      "item": "https://csmyx.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "rCore 学习笔记1",
      "item": "https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "rCore 学习笔记1",
  "name": "rCore 学习笔记1",
  "description": "系列: rCore-Camp-Guide-2025S，对应文档第3章的内容",
  "keywords": [
    
  ],
  "articleBody": "总结chapter3的内容，相关练习和简答作业。\n实现解读 参考[rCore-Camp-Guide-2025S 文档，我对ch3分支的新增代码实现的个人解读。\n多道程序加载 链接地址和加载地址 在说明多道程序加载的实现之前，我们现说明一下两个概念：\n链接地址：即程序编译链接后二进制文件中的地址。\n加载地址：即程序在加载到内存中实际执行时的地址。\nok，然后我们再来说多道程序加载，第二章实现的是一个批处理系统，该系统一次只会加载一个用户程序，每次需要执行下个程序时，再加载指定用户程序。而多道程序加载就是说，内核在初始化的时候就将多个用户程序同时加载到了其指定执行地址，这时就要求每个用户程序的加载地址必须不同了，否则不就可能发生覆盖了嘛。\n这就是我们需要解决的问题：即保证每个用户程序有不同的加载地址。朴素的做法，就是给每个用户程序指定一个起始地址偏移即可。\n在第四章之前，kernel还没有实现地址空间隔离机制，此时用户程序的加载地址等于其链接地址。所以，如果用户程序的加载地址不同，就需要用户程序的链接地址也不同。\n接下来，就看我们是怎么控制链接地址和装载地址，来解决多道程序加载引入的地址冲突问题的。\n链接过程 用户程序的链接地址，自然是要去看user/目录下各个用户程序二进制文件是怎么构建出来的，该过程由build.py脚本来控制：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # user/build.py for app in apps: app = app[: app.find(\".\")] os.system( \"cargo rustc --bin %s %s -- -Clink-args=-Ttext=%x\" % (app, mode_arg, base_address + step * app_id) ) print( \"[build.py] application %s start with address %s\" % (app, hex(base_address + step * app_id)) ) if chapter == '3': app_id = app_id + 1 这里-Clink-arg=-Text=base_address + step * app_id指了定构建之后的代码段的起始地址。在链接脚本也能实现，只是这次通过给rustc传递编译参数的方式来实现，比较方便。\n这里关键就是13-14行，可以看出如果chapter2的话，每个用户的起始地址都是base_address。如果是chapter3，那么每个用户程序链接后会有一个step的地址偏移。只要我们保证step足够大，就能保证每个用户程序链接到不同的地址处，这就解决了链接地址的冲突。\n加载过程 再来看加载的过程，该过程通过load_apps控制：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 /// Load nth user app at /// [APP_BASE_ADDRESS + n * APP_SIZE_LIMIT, APP_BASE_ADDRESS + (n+1) * APP_SIZE_LIMIT). pub fn load_apps() { extern \"C\" { fn _num_app(); } let num_app_ptr = _num_app as usize as *const usize; let num_app = get_num_app(); let app_start = unsafe { core::slice::from_raw_parts(num_app_ptr.add(1), num_app + 1) }; // load apps for i in 0..num_app { let base_i = get_base_i(i); // clear region (base_i..base_i + APP_SIZE_LIMIT) .for_each(|addr| unsafe { (addr as *mut u8).write_volatile(0) }); // load app from data section to memory let src = unsafe { core::slice::from_raw_parts(app_start[i] as *const u8, app_start[i + 1] - app_start[i]) }; let dst = unsafe { core::slice::from_raw_parts_mut(base_i as *mut u8, src.len()) }; dst.copy_from_slice(src); } } 其实现很自然，就是按照链接地址的约定，每个用户程序加载到不同的地址偏移处。（具体操作是，是从数据段复制到代码段的指定地址处，可参考note0 [todo]）\n总结 为每个用户程序引入了一个地址偏移，这样就保证了同时加载用户程序时，不会出现地址冲突。\n分时多任务 基于时间片轮转。\n[todo]\nchapter3练习 实现内容 实现系统调用sys_trace，该系统调用的作用是获取当前任务的系统调用的历史信息，该系统调用接口如下：\n1 fn sys_trace(trace_request: usize, id: usize, data: usize) -\u003e isize 具体来说，其作用根据参数trace_request的值细分为3种：\n0：读指定地址 1：写指定地址 2：查询指定系统调用被调用过的次数 实现概要 这是我的个人实现的思考过程，不涉及具体代码实现，只提供一些思路拓展或注意事项。\ntrace_request=0、1 就是读写指定地址变量，实现很自然（chapter4 引入地址空间隔离之后，读写也会变的麻烦）\ntrace_request=2 的请求需要注意，这一次调用也计入统计。所以我们更新系统调用次数的处理逻辑需要在 sys_call 开头处，在分发系统调用逻辑之前实现。\n那么统计次数用什么数据结构来记录维护呢？很自然的想到用 HashMap，但是 HashMap 是 std 中的实现，所以我们没法用。那只能用线性容器了，毕竟系统调用的个数不多，线性查找可以接受。为了简单起见，直接用定长数组即可（其实也可以用 Vec，因为初始化时已经 init_heap 了，所以可以使用堆容器 Vec）。\n我将这个定长数组命名为 syscall_counter，显然数组元素为一个系统调用号到计数的 k-v 键值对即可，而数组长度如何确定呢，我的实现是新增了一个包含所有系统调用号的常量数组 SYSCALL_ARRAY，基于该数组我们可以确定 syscall_counter 的长度，以及数组元素需要包含的所有 key 信息。\n所以我们的syscall_counter的类型定义为：[(usize, usize); SYSCALL_ARRAY.len()]。\n确定好了数据结构，具体这个 syscall_counter 保存放在哪里呢？需要注意，系统调用次数查询是针对当前任务的，也就是说每个任务系统调用的次数统计是独立的，所以我们将 syscall_counter 放在 task manager 中。自然，初始化的逻辑就放在初始化 task manager 的 lazy_static 宏中。\n然后就是统计信息更新过程，就如上文所说，需要放在 sys_call 开头，线性查找到指定 key 将 value 自增 1 即可。最后，我们查找 syscall_counter 中给定 key 的 value，即可实现 sys_trace 的查询功能。\n当读第4章代码时，我发现我们的syscall_counter其实也可以使用BTreeMap，这玩意定义是在core中而不是在std中。\n问答作业 正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。 请同学们可以自行测试这些内容（运行 三个 bad 测例 (ch2b_bad_*.rs) ）， 描述程序出错行为，同时注意注明你使用的 sbi 及其版本。\n答：运行命令：\n1 2 3 cd os git checkout ch3 make run LOG=INFO BASE=1 出错行为如下：\nch2b_bad_address：触发StorePageFault异常，在trap_handler中报错并退出执行 ch2b_bad_instructions：触发IllegalInstruction异常，在trap_handler中报错并退出执行 ch2b_bad_register：触发IllegalInstruction异常，在trap_handler中报错并退出执行 深入理解 trap.S 中两个函数 __alltraps 和 __restore 的作用，并回答如下问题:\nL40：刚进入 __restore 时，sp 代表了什么值。请指出 __restore 的两种使用情景。\n答：sp此时保存着内核栈顶地址。[todo]\nL43-L48：这几行汇编代码特殊处理了哪些寄存器？这些寄存器的的值对于进入用户态有何意义？请分别解释。\n1 2 3 4 5 6 ld t0, 32*8(sp) ld t1, 33*8(sp) ld t2, 2*8(sp) csrw sstatus, t0 csrw sepc, t1 csrw sscratch, t2 L50-L56：为何跳过了 x2 和 x4？\n1 2 3 4 5 6 7 ld x1, 1*8(sp) ld x3, 3*8(sp) .set n, 5 .rept 27 LOAD_GP %n .set n, n+1 .endr 答：x2即sp，目前指向栈顶，需要设置完其它寄存器后再设置，即通过L60的csrrw sp, sscratch, sp来设置x2，x4是tp(Thread pointer)线程寄存器，暂时不需要设置。\nL60：该指令之后，sp 和 sscratch 中的值分别有什么意义？\n1 csrrw sp, sscratch, sp 答：执行后，sp指向用户栈，sscratch指向内核栈。\n__restore：中发生状态切换在哪一条指令？为何该指令执行之后会进入用户态？\n答：L61行的srete发生状态切换。因为该指令会根据sstatus寄存器中的SPP标志位决定切换到什么状态，而SPP标志位在之前从用户态陷入内核态时，就被设置成了标志用户态。\nL13：该指令之后，sp 和 sscratch 中的值分别有什么意义？\n1 csrrw sp, sscratch, sp 答：执行后，sp指向内核栈，sscratch指向用户栈。\n从 U 态进入 S 态是哪一条指令发生的？\n答：ecall指令。\n",
  "wordCount" : "2889",
  "inLanguage": "zh",
  "image": "https://csmyx.github.io/img/1.png","datePublished": "2025-04-13T19:35:53+08:00",
  "dateModified": "2025-04-13T19:35:53+08:00",
  "author":{
    "@type": "Person",
    "name": "csmyx"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://csmyx.github.io/zh/posts/rcore-camp-guide-2025s/rcore-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B01/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "csmyx",
    "logo": {
      "@type": "ImageObject",
      "url": "https://csmyx.github.io/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://csmyx.github.io/zh/" accesskey="h" title="csmyx (Alt + H)">csmyx</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://csmyx.github.io/zh/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://csmyx.github.io/zh/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="https://csmyx.github.io/zh/series/" title="系列">
                    <span>系列</span>
                </a>
            </li>
            <li>
                <a href="https://csmyx.github.io/zh/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://csmyx.github.io/zh/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://csmyx.github.io/zh/">首页</a>&nbsp;»&nbsp;<a href="https://csmyx.github.io/zh/posts/">文章</a></div>
    <h1 class="post-title entry-hint-parent">
      rCore 学习笔记1
    </h1>
    <div class="post-meta"><span title='2025-04-13 19:35:53 +0800 +0800'>四月 13, 2025</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;csmyx

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e8%a7%a3%e8%af%bb" aria-label="实现解读">实现解读</a><ul>
                        
                <li>
                    <a href="#%e5%a4%9a%e9%81%93%e7%a8%8b%e5%ba%8f%e5%8a%a0%e8%bd%bd" aria-label="多道程序加载">多道程序加载</a><ul>
                        
                <li>
                    <a href="#%e9%93%be%e6%8e%a5%e5%9c%b0%e5%9d%80%e5%92%8c%e5%8a%a0%e8%bd%bd%e5%9c%b0%e5%9d%80" aria-label="链接地址和加载地址">链接地址和加载地址</a></li>
                <li>
                    <a href="#%e9%93%be%e6%8e%a5%e8%bf%87%e7%a8%8b" aria-label="链接过程">链接过程</a></li>
                <li>
                    <a href="#%e5%8a%a0%e8%bd%bd%e8%bf%87%e7%a8%8b" aria-label="加载过程">加载过程</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%88%86%e6%97%b6%e5%a4%9a%e4%bb%bb%e5%8a%a1" aria-label="分时多任务">分时多任务</a></li></ul>
                </li>
                <li>
                    <a href="#chapter3%e7%bb%83%e4%b9%a0" aria-label="chapter3练习">chapter3练习</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e5%86%85%e5%ae%b9" aria-label="实现内容">实现内容</a></li>
                <li>
                    <a href="#%e5%ae%9e%e7%8e%b0%e6%a6%82%e8%a6%81" aria-label="实现概要">实现概要</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%97%ae%e7%ad%94%e4%bd%9c%e4%b8%9a" aria-label="问答作业">问答作业</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>总结chapter3的内容，相关练习和简答作业。</p>
<h3 id="实现解读">实现解读<a hidden class="anchor" aria-hidden="true" href="#实现解读">#</a></h3>
<p>参考[<a href="https://learningos.cn/rCore-Camp-Guide-2025S/index.html">rCore-Camp-Guide-2025S 文档</a>，我对<code>ch3</code>分支的新增代码实现的个人解读。</p>
<h4 id="多道程序加载">多道程序加载<a hidden class="anchor" aria-hidden="true" href="#多道程序加载">#</a></h4>
<h5 id="链接地址和加载地址">链接地址和加载地址<a hidden class="anchor" aria-hidden="true" href="#链接地址和加载地址">#</a></h5>
<p>在说明多道程序加载的实现之前，我们现说明一下两个概念：</p>
<p>链接地址：即程序编译链接后二进制文件中的地址。</p>
<p>加载地址：即程序在加载到内存中实际执行时的地址。</p>
<p>ok，然后我们再来说多道程序加载，第二章实现的是一个<code>批处理系统</code>，该系统一次只会加载一个用户程序，每次需要执行下个程序时，再加载指定用户程序。而<code>多道程序加载</code>就是说，内核在初始化的时候就将多个用户程序同时加载到了其指定执行地址，这时就要求每个用户程序的加载地址必须不同了，否则不就可能发生覆盖了嘛。</p>
<p>这就是我们需要解决的问题：即保证每个用户程序有不同的加载地址。朴素的做法，就是给每个用户程序指定一个起始地址偏移即可。</p>
<p>在第四章之前，kernel还没有实现<code>地址空间隔离机制</code>，此时用户程序的<strong>加载地址等于其链接地址</strong>。所以，如果用户程序的加载地址不同，就需要用户程序的链接地址也不同。</p>
<p>接下来，就看我们是怎么控制<code>链接地址</code>和<code>装载地址</code>，来解决<code>多道程序加载</code>引入的地址冲突问题的。</p>
<h5 id="链接过程">链接过程<a hidden class="anchor" aria-hidden="true" href="#链接过程">#</a></h5>
<p>用户程序的链接地址，自然是要去看<code>user/</code>目录下各个用户程序二进制文件是怎么构建出来的，该过程由<code>build.py</code>脚本来控制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># user/build.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">app</span> <span class="o">=</span> <span class="n">app</span><span class="p">[:</span> <span class="n">app</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cargo rustc --bin </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> -- -Clink-args=-Ttext=</span><span class="si">%x</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">mode_arg</span><span class="p">,</span> <span class="n">base_address</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">app_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;[build.py] application </span><span class="si">%s</span><span class="s2"> start with address </span><span class="si">%s</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">base_address</span> <span class="o">+</span> <span class="n">step</span> <span class="o">*</span> <span class="n">app_id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">chapter</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">app_id</span> <span class="o">=</span> <span class="n">app_id</span> <span class="o">+</span> <span class="mi">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里<code>-Clink-arg=-Text=base_address + step * app_id</code>指了定构建之后的代码段的起始地址。在链接脚本也能实现，只是这次通过给rustc传递编译参数的方式来实现，比较方便。</p>
<p>这里关键就是13-14行，可以看出如果chapter2的话，每个用户的起始地址都是<code>base_address</code>。如果是chapter3，那么每个用户程序链接后会有一个<code>step</code>的地址偏移。只要我们保证<strong>step足够大</strong>，就能保证每个用户程序链接到不同的地址处，这就解决了链接地址的冲突。</p>
<h5 id="加载过程">加载过程<a hidden class="anchor" aria-hidden="true" href="#加载过程">#</a></h5>
<p>再来看加载的过程，该过程通过<code>load_apps</code>控制：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="sd">/// Load nth user app at
</span></span></span><span class="line"><span class="cl"><span class="sd">/// [APP_BASE_ADDRESS + n * APP_SIZE_LIMIT, APP_BASE_ADDRESS + (n+1) * APP_SIZE_LIMIT).
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">load_apps</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">&#34;C&#34;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">fn</span> <span class="nf">_num_app</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">num_app_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_num_app</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">num_app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_num_app</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">app_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">from_raw_parts</span><span class="p">(</span><span class="n">num_app_ptr</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">num_app</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// load apps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">num_app</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_base_i</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// clear region
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="p">(</span><span class="n">base_i</span><span class="o">..</span><span class="n">base_i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="no">APP_SIZE_LIMIT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">.</span><span class="n">for_each</span><span class="p">(</span><span class="o">|</span><span class="n">addr</span><span class="o">|</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">).</span><span class="n">write_volatile</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// load app from data section to memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">from_raw_parts</span><span class="p">(</span><span class="n">app_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">app_start</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">app_start</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">core</span>::<span class="n">slice</span>::<span class="n">from_raw_parts_mut</span><span class="p">(</span><span class="n">base_i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">())</span><span class="w"> </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">dst</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">src</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>其实现很自然，就是按照链接地址的约定，每个用户程序加载到不同的地址偏移处。（具体操作是，是从数据段复制到代码段的指定地址处，可参考note0 [todo]）</p>
<h5 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h5>
<p>为每个用户程序引入了一个地址偏移，这样就保证了同时加载用户程序时，不会出现地址冲突。</p>
<h4 id="分时多任务">分时多任务<a hidden class="anchor" aria-hidden="true" href="#分时多任务">#</a></h4>
<p>基于时间片轮转。</p>
<p>[todo]</p>
<h3 id="chapter3练习">chapter3练习<a hidden class="anchor" aria-hidden="true" href="#chapter3练习">#</a></h3>
<h4 id="实现内容">实现内容<a hidden class="anchor" aria-hidden="true" href="#实现内容">#</a></h4>
<p>实现系统调用<code>sys_trace</code>，该系统调用的作用是获取当前任务的系统调用的历史信息，该系统调用接口如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">sys_trace</span><span class="p">(</span><span class="n">trace_request</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">id</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">isize</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体来说，其作用根据参数<code>trace_request</code>的值细分为3种：</p>
<ul>
<li>0：读指定地址</li>
<li>1：写指定地址</li>
<li>2：查询指定系统调用被调用过的次数</li>
</ul>
<h4 id="实现概要">实现概要<a hidden class="anchor" aria-hidden="true" href="#实现概要">#</a></h4>
<p>这是我的个人实现的思考过程，不涉及具体代码实现，只提供一些思路拓展或注意事项。</p>
<ul>
<li>
<p><code>trace_request</code>=0、1 就是读写指定地址变量，实现很自然（chapter4 引入地址空间隔离之后，读写也会变的麻烦）</p>
</li>
<li>
<p><code>trace_request</code>=2 的请求需要注意，这一次调用也计入统计。所以我们更新系统调用次数的处理逻辑需要在 <code>sys_call</code> 开头处，在分发系统调用逻辑之前实现。</p>
</li>
<li>
<p>那么统计次数用什么数据结构来记录维护呢？很自然的想到用 <code>HashMap</code>，但是 <code>HashMap</code> 是 <code>std</code> 中的实现，所以我们没法用。那只能用线性容器了，毕竟系统调用的个数不多，线性查找可以接受。为了简单起见，直接用定长数组即可（其实也可以用 <code>Vec</code>，因为初始化时已经 <code>init_heap</code> 了，所以可以使用堆容器 <code>Vec</code>）。</p>
<p>我将这个定长数组命名为 <code>syscall_counter</code>，显然数组元素为一个系统调用号到计数的 <code>k-v</code> 键值对即可，而数组长度如何确定呢，我的实现是新增了一个包含所有系统调用号的常量数组 <code>SYSCALL_ARRAY</code>，基于该数组我们可以确定 <code>syscall_counter</code> 的长度，以及数组元素需要包含的所有 <code>key</code> 信息。</p>
<p>所以我们的<code>syscall_counter</code>的类型定义为：<code>[(usize, usize); SYSCALL_ARRAY.len()]</code>。</p>
</li>
<li>
<p>确定好了数据结构，具体这个 <code>syscall_counter</code> 保存放在哪里呢？需要注意，系统调用次数查询是针对当前任务的，也就是说每个任务系统调用的次数统计是独立的，所以我们将 <code>syscall_counter</code> 放在 <code>task manager</code> 中。自然，初始化的逻辑就放在初始化 <code>task manager</code> 的 <code>lazy_static</code> 宏中。</p>
<p>然后就是统计信息更新过程，就如上文所说，需要放在 <code>sys_call</code> 开头，线性查找到指定 <code>key</code> 将 <code>value</code> 自增 1 即可。最后，我们查找 <code>syscall_counter</code> 中给定 <code>key</code> 的 <code>value</code>，即可实现 <code>sys_trace</code> 的查询功能。</p>
</li>
<li>
<p>当读第4章代码时，我发现我们的<code>syscall_counter</code>其实也可以使用<code>BTreeMap</code>，这玩意定义是在<code>core</code>中而不是在<code>std</code>中。</p>
</li>
</ul>
<h3 id="问答作业">问答作业<a hidden class="anchor" aria-hidden="true" href="#问答作业">#</a></h3>
<ol>
<li>
<p>正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。 请同学们可以自行测试这些内容（运行 <a href="https://github.com/LearningOS/rCore-Tutorial-Test-2025S/tree/master/src/bin">三个 bad 测例 (ch2b_bad_*.rs)</a> ）， 描述程序出错行为，同时注意注明你使用的 sbi 及其版本。</p>
<p>答：运行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nb">cd</span> os
</span></span><span class="line"><span class="cl">git checkout ch3
</span></span><span class="line"><span class="cl"> make run <span class="nv">LOG</span><span class="o">=</span>INFO <span class="nv">BASE</span><span class="o">=</span><span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="/img/1.png#center" style="zoom:67%;" />
<p>出错行为如下：</p>
<ul>
<li>ch2b_bad_address：触发<code>StorePageFault</code>异常，在<code>trap_handler</code>中报错并退出执行</li>
<li>ch2b_bad_instructions：触发<code>IllegalInstruction</code>异常，在<code>trap_handler</code>中报错并退出执行</li>
<li>ch2b_bad_register：触发<code>IllegalInstruction</code>异常，在<code>trap_handler</code>中报错并退出执行</li>
</ul>
</li>
<li>
<p>深入理解 <a href="https://github.com/LearningOS/rCore-Camp-Code-2025S/blob/ch3/os/src/trap/trap.S">trap.S</a> 中两个函数 <code>__alltraps</code> 和 <code>__restore</code> 的作用，并回答如下问题:</p>
<ol>
<li>
<p>L40：刚进入 <code>__restore</code> 时，<code>sp</code> 代表了什么值。请指出 <code>__restore</code> 的两种使用情景。</p>
<p>答：<code>sp</code>此时保存着内核栈顶地址。[todo]</p>
</li>
<li>
<p>L43-L48：这几行汇编代码特殊处理了哪些寄存器？这些寄存器的的值对于进入用户态有何意义？请分别解释。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ld t0, 32*8(sp)
</span></span><span class="line"><span class="cl">ld t1, 33*8(sp)
</span></span><span class="line"><span class="cl">ld t2, 2*8(sp)
</span></span><span class="line"><span class="cl">csrw sstatus, t0
</span></span><span class="line"><span class="cl">csrw sepc, t1
</span></span><span class="line"><span class="cl">csrw sscratch, t2
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>L50-L56：为何跳过了 <code>x2</code> 和 <code>x4</code>？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ld x1, 1*8(sp)
</span></span><span class="line"><span class="cl">ld x3, 3*8(sp)
</span></span><span class="line"><span class="cl">.set n, 5
</span></span><span class="line"><span class="cl">.rept 27
</span></span><span class="line"><span class="cl">   LOAD_GP %n
</span></span><span class="line"><span class="cl">   .set n, n+1
</span></span><span class="line"><span class="cl">.endr
</span></span></code></pre></td></tr></table>
</div>
</div><p>答：<code>x2</code>即<code>sp</code>，目前指向栈顶，需要设置完其它寄存器后再设置，即通过L60的<code>csrrw sp, sscratch, sp</code>来设置<code>x2</code>，<code>x4</code>是<code>tp(Thread pointer)</code>线程寄存器，暂时不需要设置。</p>
</li>
<li>
<p>L60：该指令之后，<code>sp</code> 和 <code>sscratch</code> 中的值分别有什么意义？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">csrrw sp, sscratch, sp
</span></span></code></pre></td></tr></table>
</div>
</div><p>答：执行后，<code>sp</code>指向用户栈，<code>sscratch</code>指向内核栈。</p>
</li>
<li>
<p><code>__restore</code>：中发生状态切换在哪一条指令？为何该指令执行之后会进入用户态？</p>
<p>答：L61行的<code>srete</code>发生状态切换。因为该指令会根据<code>sstatus</code>寄存器中的<code>SPP</code>标志位决定切换到什么状态，而<code>SPP</code>标志位在之前从用户态陷入内核态时，就被设置成了标志用户态。</p>
</li>
<li>
<p>L13：该指令之后，<code>sp</code> 和 <code>sscratch</code> 中的值分别有什么意义？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">csrrw sp, sscratch, sp
</span></span></code></pre></td></tr></table>
</div>
</div><p>答：执行后，<code>sp</code>指向内核栈，<code>sscratch</code>指向用户栈。</p>
</li>
<li>
<p>从 U 态进入 S 态是哪一条指令发生的？</p>
<p>答：<code>ecall</code>指令。</p>
</li>
</ol>
</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://github.com/csmyx/csmyx.github.io">csmyx</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
