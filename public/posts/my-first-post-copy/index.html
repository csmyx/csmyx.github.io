<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>rCore-Camp-2025S 学习笔记 | csmyx blog</title>
<meta name=keywords content><meta name=description content="chapter 1
remove std-lib dependency
remove std support
Cause we want to develop our own os, so we can&rsquo;t depend on the std lib. so we add #![no_std] in front of main.rs to remove dependency on std lib. we only use the core lib, which is decouple from os (I think).
add panic_handler
We need a panic_handler to make the crab happy. It is support by std, but not core. So we add it manually in a mod lang_items. Then we remove the main function, and add #![no_main] in fron of main.rs too. Now we finally got a useless but complete program, that doesn&rsquo;t rely on std lib provided by os!"><meta name=author content="Me"><link rel=canonical href=http://localhost:1313/posts/my-first-post-copy/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/my-first-post-copy/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/posts/my-first-post-copy/"><meta property="og:site_name" content="csmyx blog"><meta property="og:title" content="rCore-Camp-2025S 学习笔记"><meta property="og:description" content="chapter 1 remove std-lib dependency remove std support Cause we want to develop our own os, so we can’t depend on the std lib. so we add #![no_std] in front of main.rs to remove dependency on std lib. we only use the core lib, which is decouple from os (I think).
add panic_handler We need a panic_handler to make the crab happy. It is support by std, but not core. So we add it manually in a mod lang_items. Then we remove the main function, and add #![no_main] in fron of main.rs too. Now we finally got a useless but complete program, that doesn’t rely on std lib provided by os!"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-10T05:22:17+08:00"><meta property="article:modified_time" content="2025-04-10T05:22:17+08:00"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="rCore-Camp-2025S 学习笔记"><meta name=twitter:description content="chapter 1
remove std-lib dependency
remove std support
Cause we want to develop our own os, so we can&rsquo;t depend on the std lib. so we add #![no_std] in front of main.rs to remove dependency on std lib. we only use the core lib, which is decouple from os (I think).
add panic_handler
We need a panic_handler to make the crab happy. It is support by std, but not core. So we add it manually in a mod lang_items. Then we remove the main function, and add #![no_main] in fron of main.rs too. Now we finally got a useless but complete program, that doesn&rsquo;t rely on std lib provided by os!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"rCore-Camp-2025S 学习笔记","item":"http://localhost:1313/posts/my-first-post-copy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"rCore-Camp-2025S 学习笔记","name":"rCore-Camp-2025S 学习笔记","description":"chapter 1 remove std-lib dependency remove std support Cause we want to develop our own os, so we can\u0026rsquo;t depend on the std lib. so we add #![no_std] in front of main.rs to remove dependency on std lib. we only use the core lib, which is decouple from os (I think).\nadd panic_handler We need a panic_handler to make the crab happy. It is support by std, but not core. So we add it manually in a mod lang_items. Then we remove the main function, and add #![no_main] in fron of main.rs too. Now we finally got a useless but complete program, that doesn\u0026rsquo;t rely on std lib provided by os!\n","keywords":[],"articleBody":"chapter 1 remove std-lib dependency remove std support Cause we want to develop our own os, so we can’t depend on the std lib. so we add #![no_std] in front of main.rs to remove dependency on std lib. we only use the core lib, which is decouple from os (I think).\nadd panic_handler We need a panic_handler to make the crab happy. It is support by std, but not core. So we add it manually in a mod lang_items. Then we remove the main function, and add #![no_main] in fron of main.rs too. Now we finally got a useless but complete program, that doesn’t rely on std lib provided by os!\nBuild a user-space execution environment support syscall Implement syscall function by ecall in risc-v assembly.\nsupport exit Call #93 of syscall, with exit state number as args0.\nsupport print Call #64 of syscall, with fd as args0, buffer ptr as args1, buffer len as args2. Then implement formatting macros: print! and println!. So we got our hello world program ourselves instead of std-lib!\nBuild a bare-metal execution environment support shutdown Use ecall to implement shutdown, althgh it’s the same option instrucion we used earlier, but now we are using it to call SBI to shutdown the kernel, while we used it to call OS to support syscall before.\nset memory layout by linker script Add a linker script src/linker.ld to manually control the memory layout of the elf file.\nconfigure the stack space layout Add src/entry.asm to init the stack space by assembly.\nclear bss section bss section is used to store uninitialized global variables and static variables declared in the program. And it’s os’s responsibility to zero out the contents of this section. So we add a function clear_bss to do it, and we used the symbol sbss and ebss to determine the start and end address of bss section.\nadd logging Add src/logging.rs to support nice logging.\nchapter 2 chapter 3 chapter 4 陷入trap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 __alltraps: csrrw sp, sscratch, sp # now sp-\u003e*TrapContext in user space, sscratch-\u003euser stack # save other general purpose registers sd x1, 1*8(sp) # skip sp(x2), we will save it later sd x3, 3*8(sp) # skip tp(x4), application does not use it # save x5~x31 .set n, 5 .rept 27 SAVE_GP %n .set n, n+1 .endr # we can use t0/t1/t2 freely, because they have been saved in TrapContext csrr t0, sstatus csrr t1, sepc sd t0, 32*8(sp) sd t1, 33*8(sp) # read user stack from sscratch and save it in TrapContext csrr t2, sscratch sd t2, 2*8(sp) # load kernel_satp into t0 ld t0, 34*8(sp) # load trap_handler into t1 ld t1, 36*8(sp) # move to kernel_sp ld sp, 35*8(sp) # switch to kernel space csrw satp, t0 sfence.vma # jump to trap_handler jr t1 流程如下：\n1-22行：保存trap context（即当前所有寄存器的值）到用户栈上\n当trap发生时，此时还处于用户空间，然后sp和sscratch分别指向用户栈顶和用户栈上的trap context。执行csrrw之后，sp指向了分配的trap context，然后就可以开始执行保存trap context的操作：就是执行一系列的sd操作，将寄存器的值保存到sp指向的trap context中。需要注意真正需要保存的x2（即sp）的值在sscratch中，需要特殊处理一下。\n23-31 行：从用户空间切换到内核空间，跳转到trap handler执行\n执行到 23 行时我们仍处于用户空间，具体来说，我们需要设置 3 个寄存器的值，这 3 个寄存器的值都从trap context中获取。\n设置sp寄存器，指向内核栈 设置ra寄存器，指向trap handler 设置stap寄存器，指向内核空间（页表）的根地址，此时就切换到内核空间了 需要注意，由于这些寄存器的值是从用户栈上的获取，必须必须在第 30 行设置stap之前完成读取。\n32-33行：跳到trap_handler，这里使用jump register 而不是像第二章时直接call trap_handler，是因为后者是根据相对虚拟地址来跳转，而前者是根据绝对虚拟地址。开启MMU后，由于我们的trampline和实际物理地址不是直接映射，所以相对虚拟地址就不对了\n完成设置之后，就可以跳转到trap handler，在内核地址空间里\t处理trap了\n以上流程的正确执行需要如下Preconditions：\n已经在用户栈上分配了trap context的空间，且其中保存了3个重要的值：内核栈地址、trap handler地址、内核空间根页表物理地址 sp指向用户栈顶，sscratch指向用户栈上的trap context 然后执行之后存在如下Postconditions：\n处于内核地址空间 sp指向内核栈顶 用户进程的trap context已经保存到了用户栈上，且sscratch指向用户栈顶 trap返回 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 __restore: # a0: *TrapContext in user space(Constant); a1: user space token # switch to user space csrw satp, a1 sfence.vma csrw sscratch, a0 mv sp, a0 # now sp points to TrapContext in user space, start restoring based on it # restore sstatus/sepc ld t0, 32*8(sp) ld t1, 33*8(sp) csrw sstatus, t0 csrw sepc, t1 # restore general purpose registers except x0/sp/tp ld x1, 1*8(sp) ld x3, 3*8(sp) .set n, 5 .rept 27 LOAD_GP %n .set n, n+1 .endr # back to user stack ld sp, 2*8(sp) sret Preconditions: a0 指向用户栈上的trap context，a1指向用户空间根页表物理地址 流程如下： 1-5行：切换回用户空间 6行：将a0保存到sscratch 7行-23行：根据a0恢复trap context 24行：sret回到用户态（U mode） Postconditions： sscratch指向用户栈上的trap context 处于用户地址空间 已经根据trap context重置了寄存器状态 questions 假设存在N个app，此时有几个页表？有几个虚拟页同时映射到trampoline这个物理页？\n朴素的答案是：N+1，N+2。考虑系统调用时，会通过PageTable::from_token，构造一个临时页表用于访问用户空间，但是该临时页表其实也是复用的用户页表的根页表，所以不会影响答案。\n为什么call trap_handler需要换成jr t1？为啥call只能是对pc的相对虚拟地址调整，而不能是直接对pc赋值为绝对虚拟地址，原因和地址长度及指令长度相关\n如果我使用call trap_handler，是否有可能能够正常执行？如果去掉.text.trampoline之后的align(4K)之后，有没有可能呢？如果在内核态出错（比如call trap_handler导致出错）会发生什么情况\n为啥需要在用户空间专门分配一个页面来保存trap context，而不是继续保存在内核栈上？\n因为只有一个备用寄存器sscratch，无法同时保存satp和kernel_stack_top的值。于是我们统一将satp和kernel_stack_top的值保存用户页面上中，然后sscratch保存该页面的地址即可通过sscratch同时获取这两个值了。\n为啥需要 set_kernel_trap_entry和 set_user_trap_entry？\n在用户态执行时（陷入内核之前），sscratch的值是啥？\n始终等于TRAP_CONTEXT_BASE\ntrap_context中有哪些变量是用于读的，哪些是用于写的？用于读的的变量的值在初始化之后会被修改吗？\nkernel_stap, kernel_sp, trap_handler是用于读的，其余是用于写的。其中kernel_satp和kernel_sp在初始化之后保持不变，而trap_handler在进入trap_handler时会被设置成trap_from_kernel，而在进入trap_return时会被设置回TRAMPOLINE。\nlab:\nPageTable::from_token只是用于trap后处于内核空间时，通过该token临时构造一个用于查询用户内存空间的页表，该页表不会被赋值给satp，不进行实际的地址转换作用，不负责管理用户帧的分配回收，frames置为空。\n而在sys_mmap中涉及到分配frame之后，就不再能够使用PageTable::from_token临时构造页表了，而是直接使用用户空间的原始内核页表，而且光使用页表也是不够的，需要直接调用memory_set的insert_framed_area方法添加一个map_area。\n尝试构造非法虚拟地址，看调用sys_get_time或sys_trace是否符合预期，返回-1\n为啥测试用例调用4次get_time，但只是assert(3 \u003c= count(sys_get_time))?\n页表标志位用法：最低一级页表的pte，除了V标志位以外，RWXU标志位也有效（因为pte中存的是物理帧地址），而其它级别页表由于pte中存的是下一级的页表的物理地址，所以只有V标志位有用。而且有一个细节，最低一级页表的pte的标志位是在PageTable::map中完成的，而其它级别页表的pte的标志位是在PageTable::find_pte_create中设置的。\n最低一级页表的RWXU标志位是根据逻辑段MapArea的map permission来设置，因此用户可访问权限的逻辑段的初始化，一定要赋予该U权限。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 /// Include sections in elf and trampoline and TrapContext and user stack, /// also returns user_sp_base and entry point. pub fn from_elf(elf_data: \u0026[u8]) -\u003e (Self, usize, usize) { let mut memory_set = Self::new_bare(); // map trampoline memory_set.map_trampoline(); // map program headers of elf, with U flag let elf = xmas_elf::ElfFile::new(elf_data).unwrap(); let elf_header = elf.header; let magic = elf_header.pt1.magic; assert_eq!(magic, [0x7f, 0x45, 0x4c, 0x46], \"invalid elf!\"); let ph_count = elf_header.pt2.ph_count(); let mut max_end_vpn = VirtPageNum(0); for i in 0..ph_count { let ph = elf.program_header(i).unwrap(); if ph.get_type().unwrap() == xmas_elf::program::Type::Load { let start_va: VirtAddr = (ph.virtual_addr() as usize).into(); let end_va: VirtAddr = ((ph.virtual_addr() + ph.mem_size()) as usize).into(); let mut map_perm = MapPermission::U; let ph_flags = ph.flags(); if ph_flags.is_read() { map_perm |= MapPermission::R; } } } } 与该标志位设置相关的bugfix：\n","wordCount":"850","inLanguage":"en","image":"http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-04-10T05:22:17+08:00","dateModified":"2025-04-10T05:22:17+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/my-first-post-copy/"},"publisher":{"@type":"Organization","name":"csmyx blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">rCore-Camp-2025S 学习笔记</h1><div class=post-meta><span title='2025-04-10 05:22:17 +0800 CST'>April 10, 2025</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;850 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/my-first-post%20copy.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h2 id=chapter-1>chapter 1<a hidden class=anchor aria-hidden=true href=#chapter-1>#</a></h2><h3 id=remove-std-lib-dependency>remove std-lib dependency<a hidden class=anchor aria-hidden=true href=#remove-std-lib-dependency>#</a></h3><h4 id=remove-std-support>remove std support<a hidden class=anchor aria-hidden=true href=#remove-std-support>#</a></h4><p>Cause we want to develop our own os, so we can&rsquo;t depend on the <code>std</code> lib. so we add <code>#![no_std]</code> in front of main.rs to remove dependency on <code>std</code> lib. we only use the <code>core</code> lib, which is decouple from os (I think).</p><h4 id=add-panic_handler>add panic_handler<a hidden class=anchor aria-hidden=true href=#add-panic_handler>#</a></h4><p>We need a panic_handler to make the crab happy. It is support by <code>std</code>, but not <code>core</code>. So we add it manually in a mod <code>lang_items</code>. Then we remove the main function, and add <code>#![no_main]</code> in fron of main.rs too. Now we finally got a useless but complete program, that doesn&rsquo;t rely on std lib provided by os!</p><h3 id=build-a-user-space-execution-environment>Build a user-space execution environment<a hidden class=anchor aria-hidden=true href=#build-a-user-space-execution-environment>#</a></h3><h4 id=support-syscall>support syscall<a hidden class=anchor aria-hidden=true href=#support-syscall>#</a></h4><p>Implement syscall function by <code>ecall</code> in risc-v assembly.</p><h4 id=support-exit>support exit<a hidden class=anchor aria-hidden=true href=#support-exit>#</a></h4><p>Call #93 of syscall, with exit state number as args0.</p><h4 id=support-print>support print<a hidden class=anchor aria-hidden=true href=#support-print>#</a></h4><p>Call #64 of syscall, with fd as args0, buffer ptr as args1, buffer len as args2. Then implement formatting macros: <code>print!</code> and <code>println!</code>. So we got our hello world program ourselves instead of std-lib!</p><h3 id=build-a-bare-metal-execution-environment>Build a bare-metal execution environment<a hidden class=anchor aria-hidden=true href=#build-a-bare-metal-execution-environment>#</a></h3><h4 id=support-shutdown>support shutdown<a hidden class=anchor aria-hidden=true href=#support-shutdown>#</a></h4><p>Use <code>ecall</code> to implement shutdown, althgh it&rsquo;s the same option instrucion we used earlier, but now we are using it to call SBI to shutdown the kernel, while we used it to call OS to support syscall before.</p><h4 id=set-memory-layout-by-linker-script>set memory layout by linker script<a hidden class=anchor aria-hidden=true href=#set-memory-layout-by-linker-script>#</a></h4><p>Add a linker script <code>src/linker.ld</code> to manually control the memory layout of the elf file.</p><h4 id=configure-the-stack-space-layout>configure the stack space layout<a hidden class=anchor aria-hidden=true href=#configure-the-stack-space-layout>#</a></h4><p>Add <code>src/entry.asm</code> to init the stack space by assembly.</p><h4 id=clear-bss-section>clear bss section<a hidden class=anchor aria-hidden=true href=#clear-bss-section>#</a></h4><p>bss section is used to store uninitialized global variables and static variables declared in the program. And it&rsquo;s os&rsquo;s responsibility to zero out the contents of this section. So we add a function <code>clear_bss</code> to do it, and we used the symbol sbss and ebss to determine the start and end address of bss section.</p><h4 id=add-logging>add logging<a hidden class=anchor aria-hidden=true href=#add-logging>#</a></h4><p>Add <code>src/logging.rs</code> to support nice logging.</p><h2 id=chapter-2>chapter 2<a hidden class=anchor aria-hidden=true href=#chapter-2>#</a></h2><h2 id=chapter-3>chapter 3<a hidden class=anchor aria-hidden=true href=#chapter-3>#</a></h2><h2 id=chapter-4>chapter 4<a hidden class=anchor aria-hidden=true href=#chapter-4>#</a></h2><h3 id=陷入trap>陷入trap<a hidden class=anchor aria-hidden=true href=#陷入trap>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>__alltraps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>csrrw</span> <span class=n>sp</span><span class=p>,</span> <span class=n>sscratch</span><span class=p>,</span> <span class=n>sp</span>
</span></span><span class=line><span class=cl>    <span class=c1># now sp-&gt;*TrapContext in user space, sscratch-&gt;user stack</span>
</span></span><span class=line><span class=cl>    <span class=c1># save other general purpose registers</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=n>x1</span><span class=p>,</span> <span class=mi>1</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># skip sp(x2), we will save it later</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=n>x3</span><span class=p>,</span> <span class=mi>3</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># skip tp(x4), application does not use it</span>
</span></span><span class=line><span class=cl>    <span class=c1># save x5~x31</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>set</span> <span class=n>n</span><span class=p>,</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>rept</span> <span class=mi>27</span>
</span></span><span class=line><span class=cl>        <span class=n>SAVE_GP</span> <span class=o>%</span><span class=n>n</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>set</span> <span class=n>n</span><span class=p>,</span> <span class=n>n</span><span class=o>+</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>endr</span>
</span></span><span class=line><span class=cl>    <span class=c1># we can use t0/t1/t2 freely, because they have been saved in TrapContext</span>
</span></span><span class=line><span class=cl>    <span class=n>csrr</span> <span class=n>t0</span><span class=p>,</span> <span class=n>sstatus</span>
</span></span><span class=line><span class=cl>    <span class=n>csrr</span> <span class=n>t1</span><span class=p>,</span> <span class=n>sepc</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=n>t0</span><span class=p>,</span> <span class=mi>32</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=n>t1</span><span class=p>,</span> <span class=mi>33</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># read user stack from sscratch and save it in TrapContext</span>
</span></span><span class=line><span class=cl>    <span class=n>csrr</span> <span class=n>t2</span><span class=p>,</span> <span class=n>sscratch</span>
</span></span><span class=line><span class=cl>    <span class=n>sd</span> <span class=n>t2</span><span class=p>,</span> <span class=mi>2</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># load kernel_satp into t0</span>
</span></span><span class=line><span class=cl>    <span class=n>ld</span> <span class=n>t0</span><span class=p>,</span> <span class=mi>34</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># load trap_handler into t1</span>
</span></span><span class=line><span class=cl>    <span class=n>ld</span> <span class=n>t1</span><span class=p>,</span> <span class=mi>36</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># move to kernel_sp</span>
</span></span><span class=line><span class=cl>    <span class=n>ld</span> <span class=n>sp</span><span class=p>,</span> <span class=mi>35</span><span class=o>*</span><span class=mi>8</span><span class=p>(</span><span class=n>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># switch to kernel space</span>
</span></span><span class=line><span class=cl>    <span class=n>csrw</span> <span class=n>satp</span><span class=p>,</span> <span class=n>t0</span>
</span></span><span class=line><span class=cl>    <span class=n>sfence</span><span class=o>.</span><span class=n>vma</span>
</span></span><span class=line><span class=cl>    <span class=c1># jump to trap_handler</span>
</span></span><span class=line><span class=cl>    <span class=n>jr</span> <span class=n>t1</span>
</span></span></code></pre></td></tr></table></div></div><p>流程如下：</p><ul><li><p>1-22行：保存<code>trap context</code>（即当前所有寄存器的值）到用户栈上</p><p>当<code>trap</code>发生时，此时还处于用户空间，然后<code>sp</code>和<code>sscratch</code>分别指向用户栈顶和用户栈上的<code>trap context</code>。执行<code>csrrw</code>之后，<code>sp</code>指向了分配的<code>trap context</code>，然后就可以开始执行保存<code>trap context</code>的操作：就是执行一系列的<code>sd</code>操作，将寄存器的值保存到<code>sp</code>指向的<code>trap context</code>中。需要注意真正需要保存的<code>x2</code>（即<code>sp</code>）的值在<code>sscratch</code>中，需要特殊处理一下。</p></li><li><p>23-31 行：从用户空间切换到内核空间，跳转到<code>trap handler</code>执行</p><p>执行到 23 行时我们仍处于用户空间，具体来说，我们需要设置 3 个寄存器的值，这 3 个寄存器的值都从<code>trap context</code>中获取。</p><ol><li>设置<code>sp</code>寄存器，指向内核栈</li><li>设置<code>ra</code>寄存器，指向<code>trap handler</code></li><li>设置<code>stap</code>寄存器，指向内核空间（页表）的根地址，此时就切换到内核空间了</li></ol><p><strong>需要注意，由于这些寄存器的值是从用户栈上的获取，必须必须在第 30 行设置<code>stap</code>之前完成读取。</strong></p></li><li><p>32-33行：跳到trap_handler，<strong>这里使用jump register 而不是像第二章时直接call trap_handler，是因为后者是根据相对虚拟地址来跳转，而前者是根据绝对虚拟地址。开启MMU后，由于我们的trampline和实际物理地址不是直接映射，所以相对虚拟地址就不对了</strong></p><p>完成设置之后，就可以跳转到<code>trap handler</code>，在内核地址空间里 处理<code>trap</code>了</p></li></ul><p>以上流程的正确执行需要如下<strong>Preconditions</strong>：</p><ol><li>已经在用户栈上分配了<code>trap context</code>的空间，且其中保存了3个重要的值：内核栈地址、<code>trap handler</code>地址、<strong>内核空间根页表物理地址</strong></li><li><code>sp</code>指向用户栈顶，<code>sscratch</code>指向用户栈上的<code>trap context</code></li></ol><p>然后执行之后存在如下<strong>Postconditions</strong>：</p><ol><li>处于内核地址空间</li><li><code>sp</code>指向内核栈顶</li><li>用户进程的<code>trap context</code>已经保存到了用户栈上，且<code>sscratch</code>指向用户栈顶</li></ol><h3 id=trap返回>trap返回<a hidden class=anchor aria-hidden=true href=#trap返回>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>__restore:</span>
</span></span><span class=line><span class=cl>    <span class=c1># a0: *TrapContext in user space(Constant); a1: user space token
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># switch to user space
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>csrw</span> <span class=no>satp</span><span class=p>,</span> <span class=no>a1</span>
</span></span><span class=line><span class=cl>    <span class=nf>sfence.vma</span>
</span></span><span class=line><span class=cl>    <span class=nf>csrw</span> <span class=no>sscratch</span><span class=p>,</span> <span class=no>a0</span>
</span></span><span class=line><span class=cl>    <span class=nf>mv</span> <span class=no>sp</span><span class=p>,</span> <span class=no>a0</span>
</span></span><span class=line><span class=cl>    <span class=c1># now sp points to TrapContext in user space, start restoring based on it
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1># restore sstatus/sepc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>ld</span> <span class=no>t0</span><span class=p>,</span> <span class=mi>32</span><span class=p>*</span><span class=mi>8</span><span class=p>(</span><span class=no>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>ld</span> <span class=no>t1</span><span class=p>,</span> <span class=mi>33</span><span class=p>*</span><span class=mi>8</span><span class=p>(</span><span class=no>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>csrw</span> <span class=no>sstatus</span><span class=p>,</span> <span class=no>t0</span>
</span></span><span class=line><span class=cl>    <span class=nf>csrw</span> <span class=no>sepc</span><span class=p>,</span> <span class=no>t1</span>
</span></span><span class=line><span class=cl>    <span class=c1># restore general purpose registers except x0/sp/tp
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>ld</span> <span class=no>x1</span><span class=p>,</span> <span class=mi>1</span><span class=p>*</span><span class=mi>8</span><span class=p>(</span><span class=no>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>ld</span> <span class=no>x3</span><span class=p>,</span> <span class=mi>3</span><span class=p>*</span><span class=mi>8</span><span class=p>(</span><span class=no>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=na>.set</span> <span class=no>n</span><span class=p>,</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=na>.rept</span> <span class=mi>27</span>
</span></span><span class=line><span class=cl>        <span class=nf>LOAD_GP</span> <span class=nv>%n</span>
</span></span><span class=line><span class=cl>        <span class=na>.set</span> <span class=no>n</span><span class=p>,</span> <span class=no>n</span><span class=err>+</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=na>.endr</span>
</span></span><span class=line><span class=cl>    <span class=c1># back to user stack
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>ld</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>2</span><span class=p>*</span><span class=mi>8</span><span class=p>(</span><span class=no>sp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>sret</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>Preconditions:<ol><li>a0 指向用户栈上的trap context，a1指向<strong>用户空间根页表物理地址</strong></li></ol></li><li>流程如下：<ul><li>1-5行：切换回用户空间</li><li>6行：将a0保存到<code>sscratch</code></li><li>7行-23行：根据a0恢复trap context</li><li>24行：sret回到用户态（U mode）</li></ul></li><li>Postconditions：<ol><li><code>sscratch</code>指向用户栈上的<code>trap context</code></li><li>处于用户地址空间</li><li>已经根据trap context重置了寄存器状态</li></ol></li></ol><h4 id=questions>questions<a hidden class=anchor aria-hidden=true href=#questions>#</a></h4><ol><li><p>假设存在N个app，此时有几个页表？有几个虚拟页同时映射到trampoline这个物理页？</p><p>朴素的答案是：N+1，N+2。考虑系统调用时，会通过PageTable::from_token，构造一个临时页表用于访问用户空间，但是该临时页表其实也是复用的用户页表的根页表，所以不会影响答案。</p></li><li><p>为什么call trap_handler需要换成<code>jr t1</code>？为啥call只能是对pc的相对虚拟地址调整，而不能是直接对pc赋值为绝对虚拟地址，原因和地址长度及指令长度相关</p></li><li><p>如果我使用call trap_handler，是否有可能能够正常执行？如果去掉<code>.text.trampoline</code>之后的align(4K)之后，有没有可能呢？如果在内核态出错（比如call trap_handler导致出错）会发生什么情况</p></li><li><p>为啥需要在用户空间专门分配一个页面来保存trap context，而不是继续保存在内核栈上？</p><p>因为只有一个备用寄存器sscratch，无法同时保存satp和kernel_stack_top的值。于是我们统一将satp和kernel_stack_top的值保存用户页面上中，然后sscratch保存该页面的地址即可通过sscratch同时获取这两个值了。</p></li><li><p>为啥需要 <code>set_kernel_trap_entry</code>和 <code>set_user_trap_entry</code>？</p></li><li><p>在用户态执行时（陷入内核之前），sscratch的值是啥？</p><p>始终等于TRAP_CONTEXT_BASE</p></li><li><p>trap_context中有哪些变量是用于读的，哪些是用于写的？用于读的的变量的值在初始化之后会被修改吗？</p><p>kernel_stap, kernel_sp, trap_handler是用于读的，其余是用于写的。<strong>其中kernel_satp和kernel_sp在初始化之后保持不变</strong>，而trap_handler在进入trap_handler时会被设置成trap_from_kernel，而在进入trap_return时会被设置回TRAMPOLINE。</p></li></ol><p>lab:</p><ul><li><p>PageTable::from_token只是用于trap后处于内核空间时，通过该token临时构造一个用于查询用户内存空间的页表，该页表不会被赋值给satp，不进行实际的地址转换作用，不负责管理用户帧的分配回收，frames置为空。</p><p>而在sys_mmap中涉及到分配frame之后，就不再能够使用PageTable::from_token临时构造页表了，而是直接使用用户空间的原始内核页表，而且光使用页表也是不够的，需要直接调用<strong>memory_set的insert_framed_area</strong>方法添加一个map_area。</p></li><li><p>尝试构造非法虚拟地址，看调用sys_get_time或sys_trace是否符合预期，返回-1</p></li><li><p>为啥测试用例调用4次get_time，但只是assert(3 &lt;= count(sys_get_time))?</p></li><li><p><strong>页表标志位用法</strong>：最低一级页表的pte，除了V标志位以外，RWXU标志位也有效（因为pte中存的是物理帧地址），而其它级别页表由于pte中存的是下一级的页表的物理地址，所以只有V标志位有用。而且有一个细节，最低一级页表的pte的标志位是在<code>PageTable::map</code>中完成的，而其它级别页表的pte的标志位是在<code>PageTable::find_pte_create</code>中设置的。</p><p>最低一级页表的RWXU标志位是根据逻辑段MapArea的map permission来设置，<strong>因此用户可访问权限的逻辑段的初始化，一定要赋予该U权限。</strong></p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Include sections in elf and trampoline and TrapContext and user stack,
</span></span></span><span class=line><span class=cl><span class=sd>/// also returns user_sp_base and entry point.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>from_elf</span><span class=p>(</span><span class=n>elf_data</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=p>(</span><span class=bp>Self</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>memory_set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>Self</span>::<span class=n>new_bare</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// map trampoline
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>memory_set</span><span class=p>.</span><span class=n>map_trampoline</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// map program headers of elf, with U flag
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>elf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>xmas_elf</span>::<span class=n>ElfFile</span>::<span class=n>new</span><span class=p>(</span><span class=n>elf_data</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>elf_header</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elf</span><span class=p>.</span><span class=n>header</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>magic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elf_header</span><span class=p>.</span><span class=n>pt1</span><span class=p>.</span><span class=n>magic</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>magic</span><span class=p>,</span><span class=w> </span><span class=p>[</span><span class=mh>0x7f</span><span class=p>,</span><span class=w> </span><span class=mh>0x45</span><span class=p>,</span><span class=w> </span><span class=mh>0x4c</span><span class=p>,</span><span class=w> </span><span class=mh>0x46</span><span class=p>],</span><span class=w> </span><span class=s>&#34;invalid elf!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>ph_count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elf_header</span><span class=p>.</span><span class=n>pt2</span><span class=p>.</span><span class=n>ph_count</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>max_end_vpn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VirtPageNum</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>ph_count</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>ph</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elf</span><span class=p>.</span><span class=n>program_header</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>ph</span><span class=p>.</span><span class=n>get_type</span><span class=p>().</span><span class=n>unwrap</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>xmas_elf</span>::<span class=n>program</span>::<span class=n>Type</span>::<span class=n>Load</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>start_va</span>: <span class=nc>VirtAddr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ph</span><span class=p>.</span><span class=n>virtual_addr</span><span class=p>()</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>end_va</span>: <span class=nc>VirtAddr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>ph</span><span class=p>.</span><span class=n>virtual_addr</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>ph</span><span class=p>.</span><span class=n>mem_size</span><span class=p>())</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>map_perm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MapPermission</span>::<span class=n>U</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>ph_flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ph</span><span class=p>.</span><span class=n>flags</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>ph_flags</span><span class=p>.</span><span class=n>is_read</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>map_perm</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>MapPermission</span>::<span class=n>R</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>与该标志位设置相关的bugfix：</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/my-first-post-copy-7/><span class=title>« Prev</span><br><span>rCore-Camp-2025S 学习笔记</span>
</a><a class=next href=http://localhost:1313/posts/my-first-post/><span class=title>Next »</span><br><span>rCore-Camp-2025S 学习笔记</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on x" href="https://x.com/intent/tweet/?text=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f&amp;title=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0&amp;summary=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f&title=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on whatsapp" href="https://api.whatsapp.com/send?text=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on telegram" href="https://telegram.me/share/url?text=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share rCore-Camp-2025S 学习笔记 on ycombinator" href="https://news.ycombinator.com/submitlink?t=rCore-Camp-2025S%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fmy-first-post-copy%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>csmyx blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>